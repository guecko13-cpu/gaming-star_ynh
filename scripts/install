#!/bin/bash

set -euo pipefail

source /usr/share/yunohost/helpers
source "$(dirname "$0")/_common.sh"

ynh_app_setting_set --app="$app" --key=domain --value="$domain"
ynh_app_setting_set --app="$app" --key=path --value="$path"

load_settings

ynh_script_progression --message="Downloading application sources..." --weight=5

ynh_setup_source --dest_dir="$install_dir" --keep=".env"

ynh_script_progression --message="Configuring environment..." --weight=3

mkdir -p "$data_dir"
ensure_env_file
sync_static_assets

mkdir -p "$data_dir/logs"
chown -R "$app":"$app" "$install_dir" "$data_dir"

ynh_script_progression --message="Configuring services..." --weight=4

ynh_add_nginx_config
ynh_add_systemd_config

ynh_systemd_action --service_name="$app" --action=enable
ynh_systemd_action --service_name="$app" --action=start

ynh_systemd_action --service_name=nginx --action=reload

ynh_script_progression --message="Running healthcheck..." --weight=2

check_health

yunohost app ssowatconf

ynh_script_progression --message="Installation completed." --weight=1
