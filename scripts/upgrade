#!/bin/bash

set -euo pipefail

source /usr/share/yunohost/helpers
source "$(dirname "$0")/_common.sh"

load_settings

ynh_script_progression --message="Upgrading application sources..." --weight=5

ynh_setup_source --dest_dir="$install_dir"

ynh_script_progression --message="Refreshing assets..." --weight=3

ensure_env_file
sync_static_assets

chown -R "$app":"$app" "$install_dir" "$data_dir"

ynh_script_progression --message="Restarting services..." --weight=3

ynh_systemd_action --service_name="$app" --action=restart
ynh_systemd_action --service_name=nginx --action=reload

ynh_script_progression --message="Running healthcheck..." --weight=2

check_health

yunohost app ssowatconf

ynh_script_progression --message="Upgrade completed." --weight=1
