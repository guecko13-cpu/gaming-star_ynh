#!/bin/bash

set -euo pipefail

command="${1:-}"
app="${2:-}"

if [ -z "$command" ] || [ -z "$app" ]; then
    echo "Usage: $0 <command> <app>" >&2
    exit 1
fi

source /usr/share/yunohost/helpers

log_dir=$(ynh_app_setting_get --app="$app" --key=data_dir)/logs
upstream_repo=$(ynh_app_setting_get --app="$app" --key=upstream_repo)
upstream_ref=$(ynh_app_setting_get --app="$app" --key=upstream_ref)
package_repo_url=$(ynh_app_setting_get --app="$app" --key=package_repo_url)
github_token=$(ynh_app_setting_get --app="$app" --key=github_token)

mkdir -p "$log_dir"

status_file="$log_dir/maintenance.status.json"
lock_file="$log_dir/maintenance.lock"
maintenance_log="$log_dir/maintenance.log"
update_log="$log_dir/update.log"

write_status() {
    local status="$1"
    local message="$2"
    local last_upgrade="$3"
    local last_check="$4"
    local upstream_sha="$5"

    cat <<EOF_JSON > "$status_file"
{
  "status": "${status}",
  "message": "${message}",
  "last_upgrade": "${last_upgrade}",
  "last_check": "${last_check}",
  "upstream_sha": "${upstream_sha}"
}
EOF_JSON
}

current_status() {
    if [ -f "$status_file" ]; then
        cat "$status_file"
    else
        write_status "idle" "Disponible" "n/a" "n/a" "n/a"
        cat "$status_file"
    fi
}

start_upgrade() {
    if [ -f "$lock_file" ]; then
        echo "[$(date -Is)] Upgrade déjà en cours" >> "$maintenance_log"
        write_status "locked" "Upgrade déjà en cours" "n/a" "n/a" "n/a"
        exit 0
    fi

    echo "$(date -Is)" > "$lock_file"
    write_status "running" "Upgrade démarré" "$(date -Is)" "n/a" "n/a"
    echo "[$(date -Is)] Lancement upgrade" >> "$maintenance_log"

    systemd-run --quiet --collect \
        --unit="${app}-upgrade-$(date +%s)" \
        /usr/local/sbin/${app}-maintenance run-upgrade "$app" >> "$maintenance_log" 2>&1
}

run_upgrade() {
    if [ -z "$package_repo_url" ]; then
        echo "[$(date -Is)] package_repo_url manquant" >> "$update_log"
        write_status "failed" "package_repo_url manquant" "$(date -Is)" "n/a" "n/a"
        rm -f "$lock_file"
        exit 1
    fi

    echo "[$(date -Is)] Upgrade lancé" >> "$update_log"
    yunohost app upgrade "$app" -u "$package_repo_url" -F >> "$update_log" 2>&1 || rc=$?
    rc=${rc:-0}

    if [ "$rc" -eq 0 ]; then
        echo "[$(date -Is)] Upgrade terminé" >> "$update_log"
        write_status "success" "Upgrade terminé" "$(date -Is)" "n/a" "n/a"
    else
        echo "[$(date -Is)] Upgrade échoué (code ${rc})" >> "$update_log"
        write_status "failed" "Upgrade échoué (code ${rc})" "$(date -Is)" "n/a" "n/a"
    fi

    rm -f "$lock_file"
}

check_upstream() {
    if [ -z "$github_token" ]; then
        echo "[$(date -Is)] Token GitHub manquant" >> "$maintenance_log"
        write_status "failed" "Token GitHub manquant" "n/a" "$(date -Is)" "n/a"
        exit 1
    fi

    set +x
    response=$(curl -sSL -H "Authorization: Bearer ${github_token}" \
        "https://api.github.com/repos/${upstream_repo}/commits/${upstream_ref}")
    set +x

    upstream_sha=$(python3 - <<'PY'
import json
import sys
try:
    data = json.loads(sys.stdin.read())
    print(data.get('sha', 'n/a'))
except Exception:
    print('n/a')
PY
<<< "$response")

    echo "[$(date -Is)] Upstream check: ${upstream_sha}" >> "$maintenance_log"
    write_status "idle" "Check upstream terminé" "n/a" "$(date -Is)" "$upstream_sha"
}

clear_lock() {
    rm -f "$lock_file"
    write_status "idle" "Verrou supprimé" "n/a" "n/a" "n/a"
    echo "[$(date -Is)] Verrou supprimé" >> "$maintenance_log"
}

tail_logs() {
    tail -n 200 "$maintenance_log" "$update_log" 2>/dev/null || true
}

case "$command" in
    start-upgrade)
        start_upgrade
        ;;
    run-upgrade)
        run_upgrade
        ;;
    check-upstream)
        check_upstream
        ;;
    status)
        current_status
        ;;
    tail-logs)
        tail_logs
        ;;
    clear-lock)
        clear_lock
        ;;
    *)
        echo "Commande inconnue" >&2
        exit 1
        ;;
esac
